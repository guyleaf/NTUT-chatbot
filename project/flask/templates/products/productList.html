{% for product_info in product_infos %}
{% set product_status = product_info.product.status %}
{% set product_id = product_info.product.id %}
{% set can_buy = not product_status.is_deleted and product_status.is_available and product_status.quantity > 0 %}
{% set purchase_button_enabled = is_seller or can_buy %}
{% set purchase_button_text = "編輯" if is_seller else ("購買" if can_buy else "無法購買") %}
{% set return_endpoint = return_endpoint or "resources.products.search_page" %}

<div class="col">
    <div class="card">
        <img
            class="card-img-top img-thumbnail"
            src="{{ product_info.product.image_url }}"
            alt="Card image cap"
            style="opacity: {{ 0.5 if not can_buy else 1 }}"
        />
        <div class="card-body">
            <h5 class="card-title mt-3">{{ product_info.product.name }}</h5>
            <div class="mb-3 card-info">
                <div class="brand">品牌：{{ product_info.product.brand }}</div>
                <div class="price">價格：{{ product_info.product.price }}</div>
                {% if product_status.is_deleted %}
                    <label class="fw-bold text-danger">此商品已刪除</label>
                {% elif product_status.is_available %}
                    <div class="quantity">
                        剩餘數量：
                    {% if product_status.quantity > 0 %}
                        <label class="fw-bold text-success">{{ product_status.quantity }}</label>
                    {% else %}
                        <label class="fw-bold text-danger">缺貨中</label>
                    {% endif %}
                    </div>
                {% else %}
                    <label class="fw-bold text-danger">已下架</label>
                {% endif %}
            </div>

            {% if purchase_button_enabled %}
                <a
                    role="button"
                    class="btn btn-primary"
                    href="{{ url_for('resources.products.product_page', product_id=product_id, return_endpoint=return_endpoint) }}"
                >
                    {{ purchase_button_text }}
                </a>
            {% else %}
                <a
                    role="button"
                    class="btn btn-primary disabled"
                    href="#"
                    aria-disabled="true"
                >
                    {{ purchase_button_text }}
                </a>
            {% endif %}
            
            <button
                type="button"
                class="btn btn-danger addFavoriteButton"
                data-product-id="{{ product_id }}"
                style="display: {{ none if product_info.is_favorite else block }}"
            >
                加入最愛
            </button>

            <button
                type="button"
                class="btn btn-danger deleteFavoriteButton"
                data-product-id="{{ product_id }}"
                style="display: {{ block if product_info.is_favorite else none }}"
            >
                移除最愛
            </button>
        </div>
    </div>
</div>
{% endfor %}
<label class="total" style="display: none">{{ total }}</label>
